{% extends 'base.html' %}
{% block title %}Streaming Service • Movie Results{% endblock %}
{% block content %}
  <h1>Movies matching “{{ title }}”</h1>

  <div style="margin: 8px 0;">
    <strong>Sort:</strong>
    {% set qs = 'sort=' ~ (sort or 'popularity') ~ '&order=' ~ (order or 'desc') %}
    {% macro link(text, s, o) -%}
      <a class="btn btn-secondary" href="?sort={{ s }}&order={{ o }}">{{ text }}{% if sort==s and order==o %} ✓{% endif %}</a>
    {%- endmacro %}
    {{ link('Most popular', 'popularity', 'desc') }}
    {{ link('Least popular', 'popularity', 'asc') }}
    {{ link('Highest rated', 'rating', 'desc') }}
    {{ link('Lowest rated', 'rating', 'asc') }}
    {{ link('A–Z', 'name', 'asc') }}
    {{ link('Newest', 'year', 'desc') }}
    {{ link('Oldest', 'year', 'asc') }}
  </div>

  <div class="card" style="margin-top:8px;">
    <div class="card-inner">
      <table class="table" id="resultsTable">
        <thead>
          <tr>
            <th>Movie</th>
            <th>Year</th>
            <th>Popularity</th>
            <th>Rating</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for movie in results %}
          <tr>
            <td class="cell-title"><a href="/watch/movie/{{ movie.id }}">{{ movie.name }}</a></td>
            <td class="cell-year">{{ movie.year }}</td>
            <td class="cell-popularity">{{ movie.popularity|round(1) }}</td>
            <td class="cell-rating">{{ movie.rating|round(1) }}</td>
            <td class="row-actions"><a class="btn btn-secondary" href="/watch/movie/{{ movie.id }}">Watch</a></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="pager">
        <button class="btn btn-secondary" onclick="changePage('prev')">Prev</button>
        <span class="badge">Page {{ page }}</span>
        <button class="btn" onclick="changePage('next')">Next</button>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
<script>
  const nextPage = {{ page }} + 1;
  const prevPage = {{ page }} - 1;
  const sort = encodeURIComponent(`{{ sort or 'popularity' }}`);
  const order = encodeURIComponent(`{{ order or 'desc' }}`);
  function changePage(change) {
    const encTitle = encodeURIComponent(`{{ title }}`);
    const qs = `?sort=${sort}&order=${order}`;
    if (change === 'next') {
      window.location.href = `/search/movie/${encTitle}/${nextPage}/${qs}`;
    } else {
      if (prevPage <= 0) {
        alert('This is the first page!');
      } else {
        window.location.href = `/search/movie/${encTitle}/${prevPage}/${qs}`;
      }
    }
  }
</script>
{% endblock %}